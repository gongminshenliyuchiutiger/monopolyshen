<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大富翁神金利餘遊戲系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <style>
        :root {
            --bg-primary: #f0f9ff;
            --bg-secondary: #e0f2fe;
            --text-primary: #0c4a6e;
            --text-secondary: #38bdf8;
            --border-color: #bae6fd;
            --board-cell-bg: white;
            --panel-bg: white;
            --modal-bg: white;
            --button-bg: #0ea5e9;
            --button-hover-bg: #0284c7;
            --highlight-color: #0ea5e9;
            --shadow-color: rgba(14, 165, 233, 0.2);
            --game-title-start: #0ea5e9;
            --game-title-end: #7dd3fc;
            --board-center-bg-start: #7dd3fc;
            --board-center-bg-end: #0ea5e9;
            --dice-gradient-start: #ffffff;
            --dice-gradient-end: #e0f2fe;
            --icon-chance: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%23f59e0b' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L1.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.25 12L17 13.75M18.25 12L17 10.25M18.25 12l1.75.25M18.25 12l1.75-.25M12 5.25L13.75 7M12 5.25L10.25 7M12 5.25l.25-1.75M12 5.25l-.25-1.75M12 18.75L13.75 17M12 18.75L10.25 17M12 18.75l.25 1.75M12 18.75l-.25 1.75M5.25 12l1.75.25M5.25 12l1.75-.25M5.25 12l.25-1.75M5.25 12l-.25-1.75M7 13.75L5.25 12M7 10.25L5.25 12M17 13.75L18.75 12M17 10.25L18.75 12' /%3E%3C/svg%3E%0A");
            --icon-tax: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%23dc2626' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.75A.75.75 0 013 4.5h.75m0 0L21 12m-18 0h.75A.75.75 0 003 12h-.75m0 0L21 12M3 12v6.75m0 0l18-5.25m-18 5.25V12m18 0l-3.75-5.25M21 12l-3.75 5.25M3 12l3.75-5.25M3 12l3.75 5.25' /%3E%3C/svg%3E%0A");
            --icon-jail: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%237f1d1d' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M15.75 5.25v13.5m-7.5-13.5v13.5m-7.5-13.5h15a1.5 1.5 0 011.5 1.5v10.5a1.5 1.5 0 01-1.5 1.5h-15a1.5 1.5 0 01-1.5-1.5V6.75a1.5 1.5 0 011.5-1.5zm1.5 3.75a.75.75 0 00-1.5 0v2.25a.75.75 0 001.5 0v-2.25zm3 0a.75.75 0 00-1.5 0v2.25a.75.75 0 001.5 0v-2.25zm3 0a.75.75 0 00-1.5 0v2.25a.75.75 0 001.5 0v-2.25z' /%3E%3C/svg%3E%0A");
            --icon-parking: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%235b21b6' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V14.25m-17.25 4.5h12.75m0 0A4.506 4.506 0 0018.75 10.5V8.25c0-1.55-.806-2.924-2.018-3.665L15.75 4.5m-3.75 0v-.75A.75.75 0 0112.75 3h.008c.414 0 .75.336.75.75v.75m-3.75 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125H9M3.375 7.5H9m3.375 0H12m2.25 0H20.625M3.375 7.5c0-1.115.789-2.046 1.856-2.208C6.36 5.154 7.266 5.25 8.25 5.25c.241 0 .476-.015.703-.043C10.056 5.08 11.066 4.5 12 4.5c.934 0 1.944.58 3.047.707.227.028.462.043.703.043.984 0 1.89-.096 2.994-.258C20.212 5.454 21 6.385 21 7.5M3.375 7.5v6.75M20.625 7.5v6.75' /%3E%3C/svg%3E%0A");
            --icon-go: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%2316a34a' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M15 11.25l-3-3m0 0l-3 3m3-3v7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /%3E%3C/svg%3E%0A");
        }

        html.dark {
            --bg-primary: #020617;
            --bg-secondary: #0f172a;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --board-cell-bg: #1e293b;
            --panel-bg: #1e293b;
            --modal-bg: #0f172a;
            --button-bg: #38bdf8;
            --button-hover-bg: #7dd3fc;
            --highlight-color: #7dd3fc;
            --shadow-color: rgba(0,0,0,0.4);
            --game-title-start: #7dd3fc;
            --game-title-end: #e0f2fe;
            --board-center-bg-start: #38bdf8;
            --board-center-bg-end: #0ea5e9;
            --dice-gradient-start: #475569;
            --dice-gradient-end: #334155;
        }

        body {
            font-family: 'Poppins', 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.5s ease-in-out, color 0.5s ease-in-out;
        }

        .game-title {
            text-shadow: 0 0 15px color-mix(in srgb, var(--game-title-end) 50%, transparent), 0 0 5px var(--game-title-end);
            background: linear-gradient(90deg, var(--game-title-start), var(--game-title-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: background 0.5s;
            animation: pulse-title 3s infinite alternate;
        }
        @keyframes pulse-title {
            from { opacity: 0.9; transform: scale(1); }
            to { opacity: 1; transform: scale(1.02); }
        }

        .board-cell {
            border: 2px solid var(--border-color);
            background-color: var(--board-cell-bg);
            transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 6px 12px -2px var(--shadow-color), 0 4px 8px -4px var(--shadow-color);
            display: flex;
            flex-direction: column;
            transform-style: preserve-3d;
            position: relative;
        }
        .board-cell.glow {
            animation: cell-glow-animation 1.2s ease-out;
            box-shadow: 0 0 25px var(--highlight-color), 0 0 35px var(--highlight-color), 0 0 10px var(--highlight-color) inset;
            z-index: 5;
        }
        @keyframes cell-glow-animation {
            0% { filter: brightness(1.0) drop-shadow(0 0 0px var(--highlight-color)); opacity: 0.7;}
            50% { filter: brightness(1.4) drop-shadow(0 0 20px var(--highlight-color)); opacity: 1;}
            100% { filter: brightness(1.0) drop-shadow(0 0 0px var(--highlight-color)); opacity: 0.7;}
        }

        .board-cell[data-type="property"]:hover,
        .board-cell[data-type="railroad"]:hover,
        .board-cell[data-type="utility"]:hover {
            transform: translateY(-10px) rotateX(12deg) rotateY(-6deg) scale(1.08);
            box-shadow: 0 15px 25px -5px color-mix(in srgb, var(--shadow-color) 150%, transparent), 0 10px 15px -6px color-mix(in srgb, var(--shadow-color) 120%, transparent);
            z-index: 10; filter: brightness(1.05) saturate(1.1);
        }
        .cell-icon {
            width: 20px; height: 20px; background-size: contain; background-repeat: no-repeat;
            background-position: center; margin-bottom: 2px; transition: transform 0.2s ease-out;
        }
        .board-cell:hover .cell-icon { transform: scale(1.1); }
        .cell-chance { background-image: var(--icon-chance); } .cell-tax { background-image: var(--icon-tax); }
        .cell-jail { background-image: var(--icon-jail); } .cell-parking { background-image: var(--icon-parking); }
        .cell-go { background-image: var(--icon-go); }

        .board-cell-content {
            color: var(--text-secondary); font-weight: 500; transition: color 0.5s;
            flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 2px; text-align: center; overflow: hidden; position: relative;
        }
        .board-cell-content .font-bold { color: var(--text-primary); transition: color 0.5s; }

        .player-piece {
            transition: transform 0.7s cubic-bezier(0.65, 0, 0.35, 1), background-color 0.5s;
            animation: piece-float 2s infinite ease-in-out;
            border: 2px solid rgba(255,255,255,0.8); position: absolute;
            width: 20px; height: 20px; font-size: 9px; display: flex; justify-content: center; align-items: center;
            border-radius: 50%; color: white; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 20; transform: translate(var(--current-x, 0px), var(--current-y, 0px));
        }
        .player-piece.hop { animation: piece-hop-animation 0.6s ease-out forwards; }
        @keyframes piece-hop-animation {
            0% { transform: translate(var(--start-x), var(--start-y)) scale(1); }
            50% { transform: translate(var(--mid-x), var(--mid-y)) scale(1.35); }
            100% { transform: translate(var(--end-x), var(--end-y)) scale(1); }
        }
        @keyframes piece-float {
            0%, 100% { transform: translate(var(--current-x, 0px), var(--current-y, 0px)) scale(1); }
            50% { transform: translate(var(--current-x, 0px), calc(var(--current-y, 0px) - 4px)) scale(1.1); }
        }

        .dice {
            background: linear-gradient(145deg, var(--dice-gradient-start), var(--dice-gradient-end));
            color: var(--text-primary);
            box-shadow: 0 10px 20px var(--shadow-color), inset 0 -3px 6px rgba(0,0,0,0.15);
            transition: all 0.3s, background 0.5s, color 0.5s; font-family: 'Poppins', sans-serif;
            width: 100px;
            height: 50px;
            display: flex; align-items: center; justify-content: space-around;
            border-radius: 8px; font-weight: bold;
        }
        .dice.rolling i {
            animation: rolling-3d-enhanced 0.9s ease-out;
        }
        @keyframes rolling-3d-enhanced {
            0% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg) scale(1); }
            20% { transform: rotateX(180deg) rotateY(90deg) rotateZ(60deg) scale(1.1); }
            40% { transform: rotateX(270deg) rotateY(180deg) rotateZ(120deg) scale(1.2); }
            60% { transform: rotateX(360deg) rotateY(270deg) rotateZ(180deg) scale(1.15); }
            80% { transform: rotateX(360deg) rotateY(360deg) rotateZ(240deg) scale(1.1); }
            100% { transform: rotateX(360deg) rotateY(360deg) rotateZ(360deg) scale(1); }
        }
        .dice-roll-prompt {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--highlight-color);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none;
            z-index: 50;
        }
        .dice-roll-prompt.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }


        .property-color { transition: background-color 0.5s; height: 15px; width: 100%; }
        .board-row { display: flex; }
        .board-top .board-cell, .board-bottom .board-cell { flex: 1; }
        .board-middle { display: flex; }
        .board-left, .board-right { width: 80px; display: flex; flex-direction: column; }

        .board-center {
            flex: 1; background: radial-gradient(circle at 50% 40%, var(--board-center-bg-start) 0%, var(--board-center-bg-end) 100%);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5), 0 20px 40px -10px var(--shadow-color);
            transition: background 0.5s; padding: 15px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; position: relative; overflow: hidden;
            color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        #mascot {
            width: 65%; max-width: 200px; height: auto; animation: float-mascot-enhanced 5s ease-in-out infinite;
            filter: drop-shadow(0 8px 20px rgba(0,0,0,0.4)); margin-bottom: 12px;
        }
        @keyframes float-mascot-enhanced { 0%, 100% { transform: translateY(0) rotate(-2deg); } 50% { transform: translateY(-12px) rotate(2deg); } }
        .board-center::before {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(ellipse at center, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 65%);
            animation: rotate-light-enhanced 10s cubic-bezier(0.45, 0.05, 0.55, 0.95) infinite alternate;
        }
        @keyframes rotate-light-enhanced { from { transform: rotate(0deg) scale(1); opacity: 0.8; } to { transform: rotate(360deg) scale(1.3); opacity: 1; } }

        .player-info {
            background-color: var(--bg-secondary); border: 2px solid transparent;
            box-shadow: 0 8px 18px -4px var(--shadow-color);
            transition: all 0.35s, background-color 0.5s, border-color 0.5s;
            border-radius: 0.75rem; padding: 0.75rem; margin-bottom: 0.75rem;
        }
        html.dark .player-info { background-color: color-mix(in srgb, var(--panel-bg) 90%, black); }
        .player-info.active {
            border-color: var(--highlight-color); transform: translateY(-6px) scale(1.02);
            box-shadow: 0 12px 25px -5px color-mix(in srgb, var(--highlight-color) 45%, transparent);
        }

        .action-btn {
            background-image: linear-gradient(to right, var(--button-bg) 0%, color-mix(in srgb, var(--button-bg) 75%, color-mix(in srgb, var(--button-bg) 50%, white)) 100%);
            color: white; font-weight: 700; border-radius: 0.6rem;
            box-shadow: 0 5px 8px -2px var(--shadow-color), 0 3px 5px -3px var(--shadow-color);
            transition: all 0.25s cubic-bezier(0.25,0.1,0.25,1.2); padding: 0.5rem 1rem;
        }
        .action-btn:hover:not(:disabled) {
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 8px 16px -3px color-mix(in srgb, var(--button-bg) 35%, transparent);
            filter: brightness(1.15) saturate(1.05);
        }
        .action-btn:disabled {
            background-image: linear-gradient(to right, var(--border-color) 0%, color-mix(in srgb, var(--border-color) 80%, color-mix(in srgb, var(--border-color) 50%, white)) 100%);
            color: color-mix(in srgb, var(--text-primary) 50%, transparent); cursor: not-allowed;
        }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            backdrop-filter: blur(8px) saturate(150%); background-color: rgba(0,0,0,0.5);
            z-index: 100; justify-content: center; align-items: center; padding: 1rem;
        }
        .modal-content {
            background-color: var(--modal-bg); color: var(--text-primary);
            box-shadow: 0 25px 50px -12px var(--shadow-color); border: 1px solid var(--border-color);
            animation: modal-appear-enhanced 0.55s cubic-bezier(0.68, -0.6, 0.265, 1.6);
            border-radius: 0.75rem; padding: 1.5rem; max-width: 500px; width: 95%;
            position: relative;
        }
        @keyframes modal-appear-enhanced { from { opacity: 0; transform: translateY(50px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }
        .modal-close-btn:hover {
            color: var(--highlight-color);
        }


        .money-change {
            position: fixed;
            font-size: 1.5em;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            color: white;
            z-index: 10000;
            animation: money-float-enhanced 2s ease-out forwards;
            pointer-events: none;
        }
        .money-change.money-gain { background-color: rgba(74, 222, 128, 0.9); }
        .money-change.money-loss { background-color: rgba(248, 113, 113, 0.9); }
        @keyframes money-float-enhanced {
            0% { transform: translateY(0) scale(0.8); opacity: 1; }
            50% { transform: translateY(-40px) scale(1.1); opacity: 0.9; }
            100% { transform: translateY(-80px) scale(0.7); opacity: 0; }
        }
        .game-messages {
            height: 100px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 8px;
            border-radius: 0.5rem;
            background-color: var(--bg-primary);
            font-size: 0.8rem;
        }
        html.dark .game-messages { background-color: color-mix(in srgb, var(--bg-secondary) 80%, black); }
        .message-new {
            padding: 3px 0;
            border-bottom: 1px dashed color-mix(in srgb, var(--border-color) 50%, transparent);
            animation: message-slide-in-enhanced 0.4s ease-out, message-highlight-enhanced 1s 0.4s ease-out;
        }
        .message-new:last-child { border-bottom: none; }
        @keyframes message-slide-in-enhanced { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes message-highlight-enhanced { 0% { background-color: color-mix(in srgb, var(--highlight-color) 20%, transparent); } 100% { background-color: transparent; } }

        #themeSwitcher, #soundSwitcher {
            padding: 0.3rem; border-radius: 0.375rem;
            background-color: transparent;
            color: var(--text-secondary);
            transition: background-color 0.2s, color 0.2s;
        }
        #themeSwitcher:hover, #soundSwitcher:hover {
            background-color: var(--bg-secondary);
            color: var(--highlight-color);
        }
        html.dark #themeSwitcher .sun-icon { display: inline-block; } html.dark #themeSwitcher .moon-icon { display: none; }
        html:not(.dark) #themeSwitcher .sun-icon { display: none; } html:not(.dark) #themeSwitcher .moon-icon { display: inline-block; }
        #soundSwitcher.sound-on .sound-on-icon { display: inline-block; } #soundSwitcher.sound-on .sound-off-icon { display: none; }
        #soundSwitcher.sound-off .sound-on-icon { display: none; } #soundSwitcher.sound-off .sound-off-icon { display: inline-block; }

        .rules-modal-content { max-height: 80vh; overflow-y: auto; }
        .rules-modal-content h4 { font-size: 1.1em; font-weight: bold; margin-top: 0.8em; margin-bottom: 0.3em; color: var(--highlight-color); }
        .rules-modal-content p, .rules-modal-content li { font-size: 0.9em; margin-bottom: 0.3em; color: var(--text-secondary); }
        .rules-modal-content ul { list-style-type: disc; padding-left: 1.5em; }

        .footer {
            padding: 1rem 0;
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 2rem;
        }
        .board-cell { width: 80px; height: 80px; } .board-left, .board-right { width: 80px; }
        @media (max-width: 1023px) {
            .board-cell { width: 65px; height: 65px; } .board-left, .board-right { width: 65px; }
            .board-cell-content .text-xs { font-size: 0.65rem; }
            #mascot { max-width: 150px; }
            .board-center .text-3xl { font-size: 1.5rem; } .board-center .text-lg { font-size: 0.9rem; }
            .dice { width: 80px; height: 40px; } .dice i { font-size: 1.5rem !important; }
            .player-piece { width: 18px; height: 18px; font-size: 8px;}
        }
        @media (max-width: 767px) {
            .board-cell { width: 50px; height: 50px; } .board-left, .board-right { width: 50px; }
            .board-cell-content .text-xs { font-size: 0.5rem; line-height: 1.1; }
            .board-cell-content .font-bold { margin-top: 0 !important; }
            .cell-icon { width: 14px; height: 14px; margin-bottom: 1px; }
            #mascot { display: none; }
            .board-center .text-3xl { font-size: 1.2rem; } .board-center .text-lg { font-size: 0.75rem; }
            .game-title { font-size: 2rem; }
            .dice { width: 70px; height: 35px; } .dice i { font-size: 1.3rem !important; }
            .player-piece { width: 15px; height: 15px; font-size: 7px; }
        }
        @media (max-width: 479px) {
            .board-cell { width: calc((100vw - 40px) / 11); height: calc((100vw - 40px) / 11); }
            .board-left, .board-right { width: calc((100vw - 40px) / 11); }
            .property-color { height: 8px; }
            .board-cell-content .text-xs { font-size: 0.4rem; }
            .cell-icon { width: 10px; height: 10px; }
            .container { padding-left: 2px; padding-right: 2px;}
            .game-title { font-size: 1.5rem; margin-bottom: 0.5rem;}
            .dice { width: 60px; height: 30px; } .dice i { font-size: 1.1rem !important; }
            .player-piece { width: 12px; height: 12px; font-size: 6px;}
        }
        .confetti-piece { position: absolute; width: 10px; height: 20px; background-color: #f00; top: -20px; animation: fall linear; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        .owned-property-indicator {
            position: absolute; bottom: 2px; right: 2px;
            width: 10px; height: 10px; border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.3);
            box-shadow: 0 0 3px rgba(0,0,0,0.2);
        }
        @media (max-width: 767px) { .owned-property-indicator { width: 8px; height: 8px; } }
        @media (max-width: 479px) { .owned-property-indicator { width: 6px; height: 6px; } }
    </style>
</head>
<body class="flex flex-col items-center justify-center bg-[var(--bg-primary)] text-[var(--text-primary)]">
    <div class="container mx-auto px-2 sm:px-4 py-6 sm:py-8">
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-black text-center game-title mb-6 animate__animated animate__rubberBand">大富翁神金利餘遊戲系統</h1>

        <div class="flex flex-col lg:flex-row gap-6">
            <div class="w-full lg:w-2/3">
                <div id="gameBoard" class="bg-transparent p-2 sm:p-3 rounded-xl shadow-2xl">
                    <!-- Board HTML -->
                    <div class="board-row board-top">
                        <div class="board-cell" data-position="20" data-type="special"><div class="property-color bg-purple-500 dark:bg-purple-600"></div><div class="board-cell-content"><div class="cell-icon cell-parking"></div><div class="text-xs">自由停車</div></div></div>
                        <div class="board-cell" data-position="21" data-type="property"><div class="property-color bg-red-500 dark:bg-red-600"></div><div class="board-cell-content"><div class="text-xs">臺北</div><div class="text-xs font-bold mt-1">$200</div></div></div>
                        <div class="board-cell" data-position="22" data-type="chance"><div class="property-color bg-yellow-400 dark:bg-yellow-500"></div><div class="board-cell-content"><div class="cell-icon cell-chance"></div><div class="text-xs">機會</div></div></div>
                        <div class="board-cell" data-position="23" data-type="property"><div class="property-color bg-red-500 dark:bg-red-600"></div><div class="board-cell-content"><div class="text-xs">高雄</div><div class="text-xs font-bold mt-1">$180</div></div></div>
                        <div class="board-cell" data-position="24" data-type="property"><div class="property-color bg-red-500 dark:bg-red-600"></div><div class="board-cell-content"><div class="text-xs">臺中</div><div class="text-xs font-bold mt-1">$180</div></div></div>
                        <div class="board-cell" data-position="25" data-type="railroad"><div class="property-color bg-gray-700 dark:bg-gray-600"></div><div class="board-cell-content"><div class="text-xs">火車站 北站</div><div class="text-xs font-bold mt-1">$200</div></div></div>
                        <div class="board-cell" data-position="26" data-type="property"><div class="property-color bg-yellow-500 dark:bg-yellow-600"></div><div class="board-cell-content"><div class="text-xs">臺南</div><div class="text-xs font-bold mt-1">$160</div></div></div>
                        <div class="board-cell" data-position="27" data-type="property"><div class="property-color bg-yellow-500 dark:bg-yellow-600"></div><div class="board-cell-content"><div class="text-xs">新竹</div><div class="text-xs font-bold mt-1">$140</div></div></div>
                        <div class="board-cell" data-position="28" data-type="utility"><div class="property-color bg-blue-500 dark:bg-blue-600"></div><div class="board-cell-content"><div class="text-xs">水電公司</div><div class="text-xs font-bold mt-1">$150</div></div></div>
                        <div class="board-cell" data-position="29" data-type="property"><div class="property-color bg-yellow-500 dark:bg-yellow-600"></div><div class="board-cell-content"><div class="text-xs">嘉義</div><div class="text-xs font-bold mt-1">$140</div></div></div>
                        <div class="board-cell" data-position="30" data-type="go_to_jail"><div class="property-color bg-red-700 dark:bg-red-600"></div><div class="board-cell-content"><div class="cell-icon cell-jail"></div><div class="text-xs">進監獄</div></div></div>
                    </div>
                    <div class="board-middle">
                        <div class="board-left">
                            <div class="board-cell" data-position="19" data-type="property"><div class="property-color bg-orange-500 dark:bg-orange-600"></div><div class="board-cell-content"><div class="text-xs">基隆</div><div class="text-xs font-bold mt-1">$120</div></div></div>
                            <div class="board-cell" data-position="18" data-type="property"><div class="property-color bg-orange-500 dark:bg-orange-600"></div><div class="board-cell-content"><div class="text-xs">宜蘭</div><div class="text-xs font-bold mt-1">$100</div></div></div>
                            <div class="board-cell" data-position="17" data-type="chance"><div class="property-color bg-yellow-400 dark:bg-yellow-500"></div><div class="board-cell-content"><div class="cell-icon cell-chance"></div><div class="text-xs">機會</div></div></div>
                            <div class="board-cell" data-position="16" data-type="property"><div class="property-color bg-orange-500 dark:bg-orange-600"></div><div class="board-cell-content"><div class="text-xs">花蓮</div><div class="text-xs font-bold mt-1">$100</div></div></div>
                            <div class="board-cell" data-position="15" data-type="railroad"><div class="property-color bg-gray-700 dark:bg-gray-600"></div><div class="board-cell-content"><div class="text-xs">火車站 西站</div><div class="text-xs font-bold mt-1">$200</div></div></div>
                            <div class="board-cell" data-position="14" data-type="property"><div class="property-color bg-pink-400 dark:bg-pink-500"></div><div class="board-cell-content"><div class="text-xs">屏東</div><div class="text-xs font-bold mt-1">$80</div></div></div>
                            <div class="board-cell" data-position="13" data-type="property"><div class="property-color bg-pink-400 dark:bg-pink-500"></div><div class="board-cell-content"><div class="text-xs">南投</div><div class="text-xs font-bold mt-1">$60</div></div></div>
                            <div class="board-cell" data-position="12" data-type="utility"><div class="property-color bg-blue-500 dark:bg-blue-600"></div><div class="board-cell-content"><div class="text-xs">電力公司</div><div class="text-xs font-bold mt-1">$150</div></div></div>
                            <div class="board-cell" data-position="11" data-type="property"><div class="property-color bg-pink-400 dark:bg-pink-500"></div><div class="board-cell-content"><div class="text-xs">苗栗</div><div class="text-xs font-bold mt-1">$60</div></div></div>
                        </div>
                        <div class="board-center">
                            <img src="image/LiyuChillGuy.svg" alt="Mascot" id="mascot">
                            <div class="text-3xl sm:text-4xl mb-1 font-black">富甲天下金利餘</div>
                            <div class="text-lg sm:text-xl opacity-80">成為大富翁神不再只是夢想！</div>
                        </div>
                        <div class="board-right">
                            <div class="board-cell" data-position="31" data-type="property"><div class="property-color bg-green-500 dark:bg-green-600"></div><div class="board-cell-content"><div class="text-xs">彰化</div><div class="text-xs font-bold mt-1">$300</div></div></div>
                            <div class="board-cell" data-position="32" data-type="property"><div class="property-color bg-green-500 dark:bg-green-600"></div><div class="board-cell-content"><div class="text-xs">雲林</div><div class="text-xs font-bold mt-1">$300</div></div></div>
                            <div class="board-cell" data-position="33" data-type="chance"><div class="property-color bg-yellow-400 dark:bg-yellow-500"></div><div class="board-cell-content"><div class="cell-icon cell-chance"></div><div class="text-xs">機會</div></div></div>
                            <div class="board-cell" data-position="34" data-type="property"><div class="property-color bg-green-500 dark:bg-green-600"></div><div class="board-cell-content"><div class="text-xs">桃園</div><div class="text-xs font-bold mt-1">$320</div></div></div>
                            <div class="board-cell" data-position="35" data-type="railroad"><div class="property-color bg-gray-700 dark:bg-gray-600"></div><div class="board-cell-content"><div class="text-xs">火車站 東站</div><div class="text-xs font-bold mt-1">$200</div></div></div>
                            <div class="board-cell" data-position="36" data-type="chance"><div class="property-color bg-yellow-400 dark:bg-yellow-500"></div><div class="board-cell-content"><div class="cell-icon cell-chance"></div><div class="text-xs">機會</div></div></div>
                            <div class="board-cell" data-position="37" data-type="property"><div class="property-color bg-blue-700 dark:bg-blue-600"></div><div class="board-cell-content"><div class="text-xs">新北</div><div class="text-xs font-bold mt-1">$350</div></div></div>
                            <div class="board-cell" data-position="38" data-type="tax"><div class="property-color bg-red-700 dark:bg-red-600"></div><div class="board-cell-content"><div class="cell-icon cell-tax"></div><div class="text-xs">奢侈稅</div><div class="text-xs font-bold mt-1">$100</div></div></div>
                            <div class="board-cell" data-position="39" data-type="property"><div class="property-color bg-blue-700 dark:bg-blue-600"></div><div class="board-cell-content"><div class="text-xs">臺北101</div><div class="text-xs font-bold mt-1">$400</div></div></div>
                        </div>
                    </div>
                    <div class="board-row board-bottom">
                        <div class="board-cell" data-position="10" data-type="jail_visit"><div class="property-color bg-orange-300 dark:bg-orange-500"></div><div class="board-cell-content"><div class="cell-icon cell-jail"></div><div class="text-xs">監獄參觀</div></div></div>
                        <div class="board-cell" data-position="9" data-type="property"><div class="property-color bg-cyan-400 dark:bg-cyan-500"></div><div class="board-cell-content"><div class="text-xs">澎湖</div><div class="text-xs font-bold mt-1">$40</div></div></div>
                        <div class="board-cell" data-position="8" data-type="property"><div class="property-color bg-cyan-400 dark:bg-cyan-500"></div><div class="board-cell-content"><div class="text-xs">金門</div><div class="text-xs font-bold mt-1">$40</div></div></div>
                        <div class="board-cell" data-position="7" data-type="chance"><div class="property-color bg-yellow-400 dark:bg-yellow-500"></div><div class="board-cell-content"><div class="cell-icon cell-chance"></div><div class="text-xs">機會</div></div></div>
                        <div class="board-cell" data-position="6" data-type="property"><div class="property-color bg-cyan-400 dark:bg-cyan-500"></div><div class="board-cell-content"><div class="text-xs">馬祖</div><div class="text-xs font-bold mt-1">$60</div></div></div>
                        <div class="board-cell" data-position="5" data-type="railroad"><div class="property-color bg-gray-700 dark:bg-gray-600"></div><div class="board-cell-content"><div class="text-xs">火車站 南站</div><div class="text-xs font-bold mt-1">$200</div></div></div>
                        <div class="board-cell" data-position="4" data-type="tax"><div class="property-color bg-red-700 dark:bg-red-600"></div><div class="board-cell-content"><div class="cell-icon cell-tax"></div><div class="text-xs">所得稅</div><div class="text-xs font-bold mt-1">$200</div></div></div>
                        <div class="board-cell" data-position="3" data-type="property"><div class="property-color bg-amber-600 dark:bg-amber-700"></div><div class="board-cell-content"><div class="text-xs">綠島</div><div class="text-xs font-bold mt-1">$20</div></div></div>
                        <div class="board-cell" data-position="2" data-type="chance"><div class="property-color bg-yellow-400 dark:bg-yellow-500"></div><div class="board-cell-content"><div class="cell-icon cell-chance"></div><div class="text-xs">機會</div></div></div>
                        <div class="board-cell" data-position="1" data-type="property"><div class="property-color bg-amber-600 dark:bg-amber-700"></div><div class="board-cell-content"><div class="text-xs">蘭嶼</div><div class="text-xs font-bold mt-1">$20</div></div></div>
                        <div class="board-cell" data-position="0" data-type="special"><div class="property-color bg-green-600 dark:bg-green-500"></div><div class="board-cell-content"><div class="cell-icon cell-go"></div><div class="text-xs">起點</div><div class="text-xs font-bold mt-1">+$200</div></div></div>
                    </div>
                </div>
            </div>

            <div class="w-full lg:w-1/3">
                <div class="bg-[var(--panel-bg)] p-4 sm:p-5 rounded-xl shadow-2xl border-2 border-[var(--border-color)] transition-colors duration-500 space-y-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl sm:text-2xl font-bold text-[var(--highlight-color)] flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 sm:h-7 sm:w-7 mr-2 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            遊戲控制
                        </h2>
                        <div class="flex space-x-2">
                            <button id="soundSwitcher" title="切換音效" class="sound-on">
                                <svg class="w-5 h-5 sound-on-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                                <svg class="w-5 h-5 sound-off-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15zm9.94-1.536a5 5 0 010-7.072m2.828 9.9a9 9 0 010-12.728M18 18l-6-6M12 18l6-6"></path></svg>
                            </button>
                            <button id="themeSwitcher" title="切換主題">
                                <svg class="w-5 h-5 moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                                <svg class="w-5 h-5 sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            </button>
                        </div>
                    </div>

                    <div id="gameSetup" class="bg-opacity-50 bg-[var(--bg-secondary)] p-3 sm:p-4 rounded-lg shadow-inner transition-colors duration-500">
                        <h3 class="text-base sm:text-lg font-semibold mb-2 sm:mb-3 flex items-center text-[var(--text-primary)]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                            玩家設置
                        </h3>
                        <div class="mb-3">
                            <label for="playerCount" class="block text-sm font-medium text-[var(--text-primary)] mb-1">玩家人數:</label>
                            <div class="relative">
                                <select id="playerCount" class="w-full p-2 sm:p-2.5 border border-[var(--border-color)] rounded-lg appearance-none bg-[var(--panel-bg)] pr-8 focus:outline-none focus:ring-2 focus:ring-[var(--highlight-color)] text-[var(--text-primary)] transition-all text-sm">
                                    <!-- Options populated by JS -->
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-[var(--text-secondary)]"><svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg></div>
                            </div>
                        </div>
                        <div id="playerNamesContainer" class="mb-3 space-y-2 max-h-32 overflow-y-auto">
                            <!-- Player name inputs will be generated here by JS -->
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 mb-3">
                            <button id="startGameBtn" class="action-btn flex-1 flex items-center justify-center py-2 sm:py-2.5">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>開始遊戲
                            </button>
                        </div>
                        <!-- Reset button was here, moved outside -->
                    </div>

                    <div class="flex flex-col sm:flex-row gap-2 mt-2">
                        <button id="showRulesBtn" class="action-btn flex-1 py-2 text-sm bg-teal-500 hover:bg-teal-600 dark:bg-teal-600 dark:hover:bg-teal-500 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            遊戲規則
                        </button>
                        <button id="downloadLogBtn" class="action-btn flex-1 py-2 text-sm bg-sky-500 hover:bg-sky-600 dark:bg-sky-600 dark:hover:bg-sky-500 flex items-center justify-center" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            下載歷程
                        </button>
                        <button id="resetGameBtn" class="action-btn flex-1 py-2 text-sm bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-500 flex items-center justify-center" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0115.357-2m0 0H15" /></svg>
                            重設遊戲
                        </button>
                    </div>


                    <div id="currentPlayerInfoDiv" class="hidden animate__animated animate__fadeInUp">
                        <h3 class="text-base sm:text-lg font-semibold mb-2 flex items-center text-[var(--text-primary)]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                            當前玩家
                        </h3>
                        <div id="currentPlayerDisplay" class="player-info text-sm"></div>
                    </div>

                    <div id="diceControlDiv" class="hidden animate__animated animate__fadeInUp">
                        <h3 class="text-base sm:text-lg font-semibold mb-2 flex items-center text-[var(--text-primary)]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 3.293A8 8 0 0012 1a8.012 8.012 0 00-5.655 2.256C4.938 4.68 4 6.753 4 9c0 1.96.688 3.886 1.994 5.334A8.007 8.007 0 0017 14.59V19h-2v-4.5a3.5 3.5 0 00-6.126-2.374l-1-1A5.485 5.485 0 016 9c0-1.828.804-3.534 2.086-4.714A6.007 6.007 0 0112 3a6.009 6.009 0 014.714 2.286A5.488 5.488 0 0118 9.614V14a1 1 0 01-1 1h-2.5a1 1 0 110-2H16V9a1 1 0 10-2 0v1a3 3 0 106 0V4.707A1.003 1.003 0 0017.293 3.293zM9 12a1 1 0 100-2 1 1 0 000 2z" /></svg>
                            擲骰子 / 行動
                        </h3>
                        <div class="flex gap-3 sm:gap-4 items-center mb-2 sm:mb-3 relative">
                            <div class="dice-container">
                                <div id="diceDisplay" class="dice">
                                    <!-- Populated by JS -->
                                </div>
                                <div id="diceRollPrompt" class="dice-roll-prompt"></div>
                            </div>
                            <button id="rollDiceBtn" class="action-btn flex items-center px-4 sm:px-5 py-2 sm:py-2.5">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /></svg>
                                擲骰子
                            </button>
                        </div>
                        <div id="jailActionsDiv" class="hidden space-x-2">
                            <button id="payJailFineBtn" class="action-btn bg-yellow-500 hover:bg-yellow-600 dark:bg-yellow-600 dark:hover:bg-yellow-500 px-3 py-1.5 text-sm">支付 $50 保釋</button>
                        </div>
                    </div>

                    <div id="playersListDiv" class="hidden">
                        <h3 class="text-base sm:text-lg font-semibold mb-2 flex items-center text-[var(--text-primary)]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                            所有玩家
                        </h3>
                        <div id="playersContainer" class="space-y-2 sm:space-y-3 text-sm"></div>
                    </div>

                    <div>
                        <h3 class="text-base sm:text-lg font-semibold mb-2 flex items-center text-[var(--text-primary)]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                            遊戲訊息
                        </h3>
                        <div id="gameMessages" class="game-messages"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer text-center text-[var(--text-secondary)]">
            Copyright © Liyuchiutiger Gongminshen
        </div>
    </div>

    <!-- Modals -->
    <div id="buyPropertyModal" class="modal" aria-hidden="true">
        <div class="modal-content">
             <button id="closeBuyPropertyModalBtn" class="modal-close-btn" onclick="closeBuyPropertyModal(); attemptToEndTurn();">&times;</button>
            <h3 class="text-xl font-bold mb-4 flex items-center text-[var(--highlight-color)]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                購買地產
            </h3>
            <p id="propertyDetails" class="mb-4 text-[var(--text-secondary)]"></p>
            <div class="flex justify-end gap-3">
                <button id="buyPropertyBtn" class="action-btn bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-500 px-4 py-2">購買</button>
                <button id="cancelBuyBtn" class="action-btn bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-500 px-4 py-2">取消</button>
            </div>
        </div>
    </div>
    <div id="rulesModal" class="modal" aria-hidden="true">
        <div class="modal-content rules-modal-content">
            <button id="closeRulesBtn" class="modal-close-btn">&times;</button>
            <h3 class="text-xl font-bold mb-4 flex items-center text-[var(--highlight-color)]">遊戲規則</h3>
            <h4>目標：</h4>
            <p>成為最有錢的玩家，讓其他玩家破產！</p>
            <h4>遊戲流程：</h4>
            <ul>
                <li>玩家輪流擲骰子，並依照骰子點數移動棋子。</li>
                <li>移動到無人擁有的地產時，可選擇購買。若不買，則無事發生。</li>
                <li>移動到其他玩家的地產時，需支付租金。</li>
                <li>經過或降落在「起點」時，可領取 $200。</li>
            </ul>
            <h4>特殊地點：</h4>
            <ul>
                <li>機會：抽取一張機會卡並執行卡片上的指示。</li>
                <li>稅格：支付指定金額的稅金。</li>
                <li>監獄：
                    <ul>
                        <li>若「進監獄」，則直接移至監獄格，不可領取起點獎金。</li>
                        <li>在監獄中，玩家可選擇支付 $50 保釋金，或嘗試擲出相同的兩個骰子點數以離開。</li>
                        <li>若三次嘗試仍未擲出相同點數，則必須支付保释金。</li>
                        <li>在監獄中時不能收取租金。</li>
                    </ul>
                </li>
                <li>自由停車：安全地點，無事發生。</li>
            </ul>
            <h4>破產：</h4>
            <p>若玩家無法支付租金或稅金，則宣告破產，退出遊戲。其擁有的地產歸還銀行（即變為無主狀態）。</p>
            <h4>勝利條件：</h4>
            <p>最後一位未破產的玩家獲勝。</p>
        </div>
    </div>
    <div id="chanceModal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <button id="closeChanceModalBtnX" class="modal-close-btn" onclick="closeChanceModal(); attemptToEndTurn();">&times;</button>
            <h3 class="text-xl font-bold mb-4 flex items-center text-[var(--highlight-color)]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                機會卡
            </h3>
            <p id="chanceCardDetails" class="mb-4 text-[var(--text-secondary)]"></p>
            <div class="flex justify-end">
                <button id="closeChanceModalBtn" class="action-btn bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-500 px-4 py-2">確認</button>
            </div>
        </div>
    </div>
    <div id="actionInfoModal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <button id="closeActionInfoModalBtnX" class="modal-close-btn" onclick="closeActionInfoModal(); attemptToEndTurn();">&times;</button>
            <h3 id="actionInfoTitle" class="text-xl font-bold mb-4 flex items-center text-[var(--highlight-color)]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                地點資訊
            </h3>
            <p id="actionInfoDetails" class="mb-4 text-[var(--text-secondary)]"></p>
            <div class="flex justify-end">
                <button id="closeActionInfoModalBtn" class="action-btn bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-500 px-4 py-2">確認</button>
            </div>
        </div>
    </div>

    <div id="confetti-container" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;"></div>

    <script>
        // --- Sound Variables ---
        let audioCtx;
        let soundEnabled = true;

        const diceInitialHTML = `<i class="fas fa-question-circle text-2xl sm:text-3xl text-[var(--text-primary)]"></i> <i class="fas fa-question-circle text-2xl sm:text-3xl text-[var(--text-primary)]"></i>`;
        const diceFaces = ["", "one", "two", "three", "four", "five", "six"];
        const playerColors = [
            "bg-red-500", "bg-blue-500", "bg-green-500", "bg-yellow-500",
            "bg-purple-500", "bg-pink-500", "bg-indigo-500", "bg-teal-500",
            "bg-orange-500", "bg-lime-500", "bg-cyan-500", "bg-rose-500"
        ];


        let gameState = {
            players: [], currentPlayerIndex: 0, gameStarted: false, diceRolledThisTurn: false, properties: {},
            gameLog: [],
            chanceCards: [
                { text: "前進到起點，獲得 $200", action: async (player) => { await movePlayerTo(player, 0, true); player.money += 200; showMoneyChange(player, 200); } },
                { text: "支付 $50 維修費", action: async (player) => { player.money -= 50; showMoneyChange(player, -50); playSound('pay'); } },
                { text: "獲得 $100 獎金", action: async (player) => { player.money += 100; showMoneyChange(player, 100); playSound('buy');} },
                { text: "前往監獄。不要經過起點，不要領取 $200。", action: async (player) => { await goToJail(player); } },
                { text: "每位玩家給你 $10", action: async (player) => { gameState.players.forEach(p => { if (p !== player && p.money > 0) { p.money -= 10; player.money += 10; showMoneyChange(p, -10); showMoneyChange(player, 10); } }); playSound('buy'); } },
                { text: "銀行支付你 $50 紅利", action: async (player) => { player.money += 50; showMoneyChange(player, 50); playSound('buy');} },
                { text: "恭喜！你中了樂透 $150！", action: async (player) => { player.money += 150; showMoneyChange(player, 150); playSound('buy');} }
            ],
        };
        let lastDiceRollTotal = 0;
        const AUTO_END_TURN_DELAY = 2500;
        const ACTION_DELAY_MS = 1500;
        const CELL_GLOW_DURATION = 1000;

        const boardProperties = {
            1: { name: "蘭嶼", price: 60, rent: 2, color: "amber-600", type: "property" },
            3: { name: "綠島", price: 60, rent: 4, color: "amber-600", type: "property" },
            4: { name: "所得稅", price: 200, type: "tax" },
            5: { name: "火車站 南站", price: 200, rent: 25, type: "railroad" },
            6: { name: "馬祖", price: 100, rent: 6, color: "cyan-400", type: "property" },
            8: { name: "金門", price: 100, rent: 6, color: "cyan-400", type: "property" },
            9: { name: "澎湖", price: 120, rent: 8, color: "cyan-400", type: "property" },
            11: { name: "苗栗", price: 140, rent: 10, color: "pink-400", type: "property" },
            12: { name: "電力公司", price: 150, type: "utility" },
            13: { name: "南投", price: 140, rent: 10, color: "pink-400", type: "property" },
            14: { name: "屏東", price: 160, rent: 12, color: "pink-400", type: "property" },
            15: { name: "火車站 西站", price: 200, rent: 25, type: "railroad" },
            16: { name: "花蓮", price: 180, rent: 14, color: "orange-500", type: "property" },
            18: { name: "宜蘭", price: 180, rent: 14, color: "orange-500", type: "property" },
            19: { name: "基隆", price: 200, rent: 16, color: "orange-500", type: "property" },
            21: { name: "臺北", price: 220, rent: 18, color: "red-500", type: "property" },
            23: { name: "高雄", price: 220, rent: 18, color: "red-500", type: "property" },
            24: { name: "臺中", price: 240, rent: 20, color: "red-500", type: "property" },
            25: { name: "火車站 北站", price: 200, rent: 25, type: "railroad" },
            26: { name: "臺南", price: 260, rent: 22, color: "yellow-500", type: "property" },
            27: { name: "新竹", price: 260, rent: 22, color: "yellow-500", type: "property" },
            28: { name: "水電公司", price: 150, type: "utility" },
            29: { name: "嘉義", price: 280, rent: 24, color: "yellow-500", type: "property" },
            31: { name: "彰化", price: 300, rent: 26, color: "green-500", type: "property" },
            32: { name: "雲林", price: 300, rent: 26, color: "green-500", type: "property" },
            34: { name: "桃園", price: 320, rent: 28, color: "green-500", type: "property" },
            35: { name: "火車站 東站", price: 200, rent: 25, type: "railroad" },
            37: { name: "新北", price: 350, rent: 35, color: "blue-700", type: "property" },
            38: { name: "奢侈稅", price: 100, type: "tax" },
            39: { name: "臺北101", price: 400, rent: 50, color: "blue-700", type: "property" },
        };

        // --- Sound Functions ---
        function initializeAudioContext() {
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    console.log("AudioContext initialized.");
                } catch (e) {
                    console.error("Web Audio API is not supported in this browser.", e);
                    soundEnabled = false;
                    const soundSwitcher = document.getElementById("soundSwitcher");
                    soundSwitcher.classList.remove("sound-on");
                    soundSwitcher.classList.add("sound-off");
                    soundSwitcher.disabled = true;
                }
            }
        }

        function playSound(type) {
            if (!soundEnabled || !audioCtx || audioCtx.state === 'suspended') {
                if (audioCtx && audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => {
                        if (soundEnabled) playSoundInternal(type);
                    });
                }
                return;
            }
            playSoundInternal(type);
        }

        function playSoundInternal(type) {
            const now = audioCtx.currentTime;
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.connect(audioCtx.destination);

            let oscillator;

            switch (type) {
                case 'roll':
                    for (let i = 0; i < 3; i++) {
                        oscillator = audioCtx.createOscillator();
                        oscillator.type = 'triangle';
                        oscillator.frequency.setValueAtTime(Math.random() * 500 + 800, now + i * 0.07);
                        gainNode.gain.setValueAtTime(0.1, now + i * 0.07);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, now + i * 0.07 + 0.05);
                        oscillator.connect(gainNode);
                        oscillator.start(now + i * 0.07);
                        oscillator.stop(now + i * 0.07 + 0.05);
                    }
                    break;
                case 'move':
                    oscillator = audioCtx.createOscillator();
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(300, now);
                    oscillator.frequency.linearRampToValueAtTime(600, now + 0.2);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.25);
                    oscillator.connect(gainNode);
                    oscillator.start(now);
                    oscillator.stop(now + 0.25);
                    break;
                case 'buy':
                    const freqsBuy = [523.25, 659.25, 783.99];
                    freqsBuy.forEach((freq, i) => {
                        oscillator = audioCtx.createOscillator();
                        oscillator.type = 'triangle';
                        oscillator.frequency.setValueAtTime(freq, now + i * 0.05);
                        gainNode.gain.setValueAtTime(0.15, now + i * 0.05);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, now + i * 0.05 + 0.3);
                        oscillator.connect(gainNode);
                        oscillator.start(now + i * 0.05);
                        oscillator.stop(now + i * 0.05 + 0.3);
                    });
                    break;
                case 'pay':
                    oscillator = audioCtx.createOscillator();
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(440, now);
                    oscillator.frequency.linearRampToValueAtTime(220, now + 0.2);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.25);
                    oscillator.connect(gainNode);
                    oscillator.start(now);
                    oscillator.stop(now + 0.25);
                    break;
                case 'chance':
                    const freqsChance = [440, 554.37, 659.25, 880];
                    freqsChance.forEach((freq, i) => {
                        oscillator = audioCtx.createOscillator();
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(freq, now + i * 0.1);
                        gainNode.gain.setValueAtTime(0.1, now + i * 0.1);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, now + i * 0.1 + 0.1);
                        oscillator.connect(gainNode);
                        oscillator.start(now + i * 0.1);
                        oscillator.stop(now + i * 0.1 + 0.1);
                    });
                    break;
                case 'jail':
                    oscillator = audioCtx.createOscillator();
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(150, now);
                    oscillator.frequency.linearRampToValueAtTime(100, now + 0.5);
                    gainNode.gain.setValueAtTime(0.25, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.6);
                    oscillator.connect(gainNode);
                    oscillator.start(now);
                    oscillator.stop(now + 0.6);
                    break;
                case 'error':
                    oscillator = audioCtx.createOscillator();
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(100, now);
                    gainNode.gain.setValueAtTime(0.15, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                    oscillator.connect(gainNode);
                    oscillator.start(now);
                    oscillator.stop(now + 0.2);
                    break;
                case 'win':
                    const freqsWin = [523.25, 659.25, 783.99, 1046.50];
                     freqsWin.forEach((freq, i) => {
                        oscillator = audioCtx.createOscillator();
                        oscillator.type = 'triangle';
                        oscillator.frequency.setValueAtTime(freq, now + i * 0.15);
                        gainNode.gain.setValueAtTime(0.2, now + i * 0.15);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, now + i * 0.15 + 0.25);
                        oscillator.connect(gainNode);
                        oscillator.start(now + i * 0.15);
                        oscillator.stop(now + i * 0.15 + 0.25);
                    });
                    break;
                case 'passGo':
                    oscillator = audioCtx.createOscillator();
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(880, now);
                    gainNode.gain.setValueAtTime(0.15, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
                    oscillator.connect(gainNode);
                    oscillator.start(now);
                    oscillator.stop(now + 0.15);
                    break;
            }
        }

        function populatePlayerCountDropdown() {
            const playerCountSelect = document.getElementById("playerCount");
            playerCountSelect.innerHTML = '';
            for (let i = 2; i <= 12; i++) {
                const option = document.createElement("option");
                option.value = i;
                option.text = `${i} 位`;
                playerCountSelect.appendChild(option);
            }
            playerCountSelect.addEventListener('change', updatePlayerNameInputs);
            updatePlayerNameInputs();
        }

        function updatePlayerNameInputs() {
            const playerCount = parseInt(document.getElementById("playerCount").value);
            const container = document.getElementById("playerNamesContainer");
            container.innerHTML = '';

            for (let i = 0; i < playerCount; i++) {
                const inputDiv = document.createElement("div");
                inputDiv.className = "flex items-center gap-2";
                const label = document.createElement("label");
                label.htmlFor = `playerName${i + 1}`;
                label.className = "text-sm text-[var(--text-secondary)] w-12 whitespace-nowrap";
                label.innerText = `玩家 ${i + 1}:`;
                const input = document.createElement("input");
                input.type = "text";
                input.id = `playerName${i + 1}`;
                input.className = "flex-1 p-1.5 border border-[var(--border-color)] rounded-md bg-[var(--panel-bg)] text-[var(--text-primary)] text-sm focus:ring-1 focus:ring-[var(--highlight-color)] focus:outline-none";
                input.placeholder = `名稱`;
                inputDiv.appendChild(label);
                inputDiv.appendChild(input);
                container.appendChild(inputDiv);
            }
        }


        function initializeEventListeners() {
            populatePlayerCountDropdown();
            document.getElementById("startGameBtn").addEventListener("click", startGame);
            document.getElementById("resetGameBtn").addEventListener("click", resetGame);
            document.getElementById("downloadLogBtn").addEventListener("click", downloadGameLog);
            document.getElementById("rollDiceBtn").addEventListener("click", rollDice);
            document.getElementById("buyPropertyBtn").addEventListener("click", () => buyAndClosePropertyModal(gameState.players[gameState.currentPlayerIndex], gameState.players[gameState.currentPlayerIndex].position));
            document.getElementById("cancelBuyBtn").addEventListener("click", () => {
                closeBuyPropertyModal(); attemptToEndTurn();
            });
            document.getElementById("closeBuyPropertyModalBtn").addEventListener("click", () => {
                closeBuyPropertyModal(); attemptToEndTurn();
            });
            document.getElementById("payJailFineBtn").addEventListener("click", payJailFine);
            document.getElementById("showRulesBtn").addEventListener("click", showRulesModal);
            document.getElementById("closeRulesBtn").addEventListener("click", closeRulesModal);
            document.getElementById("closeChanceModalBtn").addEventListener("click", () => {
                closeChanceModal(); attemptToEndTurn();
            });
             document.getElementById("closeChanceModalBtnX").addEventListener("click", () => {
                closeChanceModal(); attemptToEndTurn();
            });
            document.getElementById("closeActionInfoModalBtn").addEventListener("click", () => {
                closeActionInfoModal();
                attemptToEndTurn();
            });
            document.getElementById("closeActionInfoModalBtnX").addEventListener("click", () => {
                closeActionInfoModal();
                attemptToEndTurn();
            });
            document.getElementById("themeSwitcher").addEventListener("click", toggleTheme);
            document.getElementById("soundSwitcher").addEventListener("click", toggleSound);

            document.getElementById("diceDisplay").innerHTML = diceInitialHTML;
        }

        function resetGame() {
            gameState.gameStarted = false;
            gameState.players = [];
            gameState.properties = {};
            gameState.currentPlayerIndex = 0;
            lastDiceRollTotal = 0;
            gameState.diceRolledThisTurn = false;
            gameState.gameLog = [];

            document.querySelectorAll('.player-piece').forEach(p => p.remove());
            document.querySelectorAll('.owned-property-indicator').forEach(i => i.remove());
            document.getElementById("gameMessages").innerHTML = "";
            document.getElementById("diceDisplay").innerHTML = diceInitialHTML;
            document.getElementById("diceRollPrompt").classList.remove("show");

            document.getElementById("gameSetup").classList.remove("hidden");
            document.getElementById("playerNamesContainer").classList.remove("hidden");
            document.getElementById("startGameBtn").disabled = false;
            // Buttons will be correctly disabled/enabled by updatePlayerDisplay

            document.getElementById("currentPlayerInfoDiv").classList.add("hidden");
            document.getElementById("diceControlDiv").classList.add("hidden");
            document.getElementById("playersListDiv").classList.add("hidden");
            document.getElementById("playersContainer").innerHTML = "";

            updatePlayerDisplay(); // This will handle disabling reset and download buttons

            addMessage("遊戲已重設。請選擇玩家數量並開始新遊戲。");
            playSound('error');
        }

        function startGame() {
            initializeAudioContext();
            gameState.gameLog = ["# 大富翁神金利餘 - 遊戲歷程\n"];

            const playerCount = parseInt(document.getElementById("playerCount").value);
            gameState.players = [];
            gameState.properties = {};
            gameState.currentPlayerIndex = 0;
            gameState.gameStarted = true;
            gameState.diceRolledThisTurn = false;
            lastDiceRollTotal = 0;

            document.querySelectorAll('.player-piece').forEach(p => p.remove());
            document.querySelectorAll('.owned-property-indicator').forEach(i => i.remove());
            document.getElementById("gameMessages").innerHTML = "";

            for (let i = 0; i < playerCount; i++) {
                const nameInput = document.getElementById(`playerName${i + 1}`);
                const playerName = nameInput && nameInput.value.trim() !== "" ? nameInput.value.trim() : `玩家 ${i + 1}`;
                const player = {
                    id: i + 1, name: playerName, money: 1500, position: 0, properties: [],
                    color: playerColors[i % playerColors.length],
                    inJail: false, jailTurns: 0, pieceOffsetX: 0, pieceOffsetY: 0
                };
                gameState.players.push(player); createPlayerPiece(player);
            }

            document.getElementById("gameSetup").classList.add("hidden");
            document.getElementById("playerNamesContainer").classList.add("hidden");
            document.getElementById("startGameBtn").disabled = true;

            document.getElementById("currentPlayerInfoDiv").classList.remove("hidden");
            document.getElementById("diceControlDiv").classList.remove("hidden");
            document.getElementById("playersListDiv").classList.remove("hidden");
            document.getElementById("diceDisplay").innerHTML = diceInitialHTML;

            updatePlayerDisplay(); // Update UI, which will also set button states

            addMessage(`遊戲開始！**${gameState.players[0].name}** 的回合。`);
        }

        function createPlayerPiece(player) {
            const piece = document.createElement("div");
            piece.className = `player-piece ${player.color}`; piece.innerText = player.id;
            const startCell = document.querySelector(`.board-cell[data-position="0"]`);
            const existingPiecesCount = startCell.querySelectorAll('.player-piece').length;

            const maxPiecesPerRowOrCol = 3;
            const pieceSpacing = 6;
            const baseOffsetX = - (maxPiecesPerRowOrCol -1) * pieceSpacing / 2;
            const baseOffsetY = - (maxPiecesPerRowOrCol -1) * pieceSpacing / 2;


            player.pieceOffsetX = baseOffsetX + (existingPiecesCount % maxPiecesPerRowOrCol) * pieceSpacing;
            player.pieceOffsetY = baseOffsetY + Math.floor(existingPiecesCount / maxPiecesPerRowOrCol) * pieceSpacing;


            piece.style.setProperty('--current-x', `${player.pieceOffsetX}px`);
            piece.style.setProperty('--current-y', `${player.pieceOffsetY}px`);
            piece.style.transform = `translate(${player.pieceOffsetX}px, ${player.pieceOffsetY}px)`;
            startCell.appendChild(piece);
        }

        function updatePlayerDisplay() {
            const diceDisplayEl = document.getElementById("diceDisplay");
            const resetGameBtn = document.getElementById("resetGameBtn");
            const downloadLogBtn = document.getElementById("downloadLogBtn");

            // Centralized logic for button states
            if (gameState.gameStarted) {
                if (resetGameBtn) resetGameBtn.disabled = false;
                if (downloadLogBtn) downloadLogBtn.disabled = false;
            } else {
                if (resetGameBtn) resetGameBtn.disabled = true;
                if (downloadLogBtn) downloadLogBtn.disabled = true;
            }

            if (!gameState.gameStarted || gameState.players.length === 0) {
                 document.getElementById("currentPlayerInfoDiv").classList.add("hidden");
                 document.getElementById("diceControlDiv").classList.add("hidden");
                 document.getElementById("playersListDiv").classList.add("hidden");
                 document.getElementById("gameSetup").classList.remove("hidden");
                 document.getElementById("playerNamesContainer").classList.remove("hidden");
                 document.getElementById("startGameBtn").disabled = false;
                 if(diceDisplayEl) diceDisplayEl.innerHTML = diceInitialHTML;
                 return;
            }


            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            document.getElementById("currentPlayerDisplay").innerHTML = `
                <div class="player-info active">
                    <div class="flex items-center mb-1">
                        <div class="w-5 h-5 sm:w-6 sm:h-6 rounded-full ${currentPlayer.color} mr-2"></div>
                        <span class="font-bold">${currentPlayer.name}</span>
                    </div>
                    <div class="text-xs sm:text-sm"><i class="fas fa-coins mr-1 text-yellow-500"></i>資金: $${currentPlayer.money}</div>
                    <div class="text-xs sm:text-sm"><i class="fas fa-map-marker-alt mr-1 text-red-500"></i>位置: ${getPositionName(currentPlayer.position)} ${currentPlayer.inJail ? "<span class='text-red-500 font-semibold'>(監獄中)</span>" : ""}</div>
                </div>`;

            const playersContainer = document.getElementById("playersContainer");
            playersContainer.innerHTML = "";
            gameState.players.forEach(player => {
                const playerDiv = document.createElement("div");
                playerDiv.className = `player-info ${player === currentPlayer ? "active" : ""}`;
                playerDiv.innerHTML = `
                    <div class="flex items-center mb-1">
                        <div class="w-5 h-5 sm:w-6 sm:h-6 rounded-full ${player.color} mr-2"></div>
                        <span class="font-bold">${player.name}</span>
                    </div>
                    <div class="text-xs sm:text-sm"><i class="fas fa-coins mr-1 text-yellow-500"></i>資金: $${player.money} ${player.inJail ? "<span class='text-red-500 font-semibold'>(監獄)</span>" : ""}</div>
                    <div class="text-xs sm:text-sm"><i class="fas fa-home mr-1 text-green-500"></i>地產: ${player.properties.length}</div>`;
                playersContainer.appendChild(playerDiv);
            });

            const rollDiceBtn = document.getElementById("rollDiceBtn");
            const jailActionsDiv = document.getElementById("jailActionsDiv");
            rollDiceBtn.disabled = gameState.diceRolledThisTurn;
            jailActionsDiv.classList.toggle("hidden", !currentPlayer.inJail || gameState.diceRolledThisTurn);

            if (currentPlayer.inJail && !gameState.diceRolledThisTurn) {
                 rollDiceBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /></svg>嘗試脫逃`;
            } else {
                 rollDiceBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /></svg>擲骰子`;
            }
        }

        function showDiceRollPrompt(total) {
            const promptEl = document.getElementById("diceRollPrompt");
            promptEl.innerText = `擲出 ${total} 點!`;
            promptEl.classList.add("show");
            setTimeout(() => {
                promptEl.classList.remove("show");
            }, 2000);
        }

        async function rollDice() {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            if (gameState.diceRolledThisTurn) return;
            gameState.diceRolledThisTurn = true;
            document.getElementById("rollDiceBtn").disabled = true;
            playSound('roll');

            const dice1 = Math.floor(Math.random() * 6) + 1;
            const dice2 = Math.floor(Math.random() * 6) + 1;
            lastDiceRollTotal = dice1 + dice2;

            const diceDisplayEl = document.getElementById("diceDisplay");
            diceDisplayEl.classList.add("rolling");
            await new Promise(resolve => setTimeout(resolve, 900));
            diceDisplayEl.classList.remove("rolling");

            diceDisplayEl.innerHTML = `
                <i class="fas fa-dice-${diceFaces[dice1]} text-2xl sm:text-3xl text-[var(--text-primary)]"></i>
                <i class="fas fa-dice-${diceFaces[dice2]} text-2xl sm:text-3xl text-[var(--text-primary)]"></i>
            `;
            showDiceRollPrompt(lastDiceRollTotal);

            if (currentPlayer.inJail) {
                addMessage(`**${currentPlayer.name}** 在監獄中擲出 ${dice1} 和 ${dice2} (總共 ${lastDiceRollTotal}點)`);
                if (dice1 === dice2) {
                    currentPlayer.inJail = false; currentPlayer.jailTurns = 0;
                    addMessage(`擲出相同點數！**${currentPlayer.name}** 成功離開監獄！`);
                    playSound('buy');
                    await movePlayer(currentPlayer, lastDiceRollTotal);
                } else {
                    addMessage(`未能擲出相同點數，**${currentPlayer.name}** 繼續待在監獄。`); currentPlayer.jailTurns++;
                    playSound('error');
                }
            } else {
                addMessage(`**${currentPlayer.name}** 擲出 ${lastDiceRollTotal} 點`);
                await movePlayer(currentPlayer, lastDiceRollTotal);
            }
            updatePlayerDisplay();
            if (!isModalOpen()) { attemptToEndTurn(); }
        }

        async function movePlayer(player, steps) {
            const oldPosition = player.position;
            let newPosition = (player.position + steps) % 40;
            player.position = newPosition;
            playSound('move');

            await movePlayerPieceAnimated(player);

            if (newPosition < oldPosition && steps > 0 && player.position !== 10 ) {
                player.money += 200; showMoneyChange(player, 200);
                addMessage(`**${player.name}** 經過起點，獲得 $200`);
                playSound('passGo');
            }

            const cellElement = document.querySelector(`.board-cell[data-position="${player.position}"]`);
            if(cellElement) {
                cellElement.classList.add('glow');
                await new Promise(resolve => setTimeout(resolve, CELL_GLOW_DURATION));
                cellElement.classList.remove('glow');
            }
            await new Promise(resolve => setTimeout(resolve, ACTION_DELAY_MS / 2));
            const actionIsPending = await handlePosition(player);

            if (!actionIsPending) {
                 await new Promise(resolve => setTimeout(resolve, ACTION_DELAY_MS / 2));
            }
        }

        async function movePlayerTo(player, position, collectGoMoney = false) {
            const oldPosition = player.position;
            player.position = position;
            playSound('move');
            await movePlayerPieceAnimated(player);

            if (collectGoMoney && position === 0 && oldPosition !== 0) {
                 player.money += 200; showMoneyChange(player, 200);
                 addMessage(`**${player.name}** 前往起點，獲得 $200`);
                 playSound('passGo');
            }
            const cellElement = document.querySelector(`.board-cell[data-position="${player.position}"]`);
            if(cellElement) {
                cellElement.classList.add('glow');
                await new Promise(resolve => setTimeout(resolve, CELL_GLOW_DURATION));
                cellElement.classList.remove('glow');
            }
            await new Promise(resolve => setTimeout(resolve, ACTION_DELAY_MS / 2));
            const actionIsPending = await handlePosition(player);
            if (!actionIsPending) {
                await new Promise(resolve => setTimeout(resolve, ACTION_DELAY_MS / 2));
            }
        }

        async function movePlayerPieceAnimated(player) {
            const piece = document.querySelector(`.player-piece.${player.color}`);
            if (!piece) return;
            const targetCell = document.querySelector(`.board-cell[data-position="${player.position}"]`);
            if (!targetCell) return;
            const currentTransform = piece.style.transform;
            const currentXY = currentTransform.match(/translate\(([^,]+),\s*([^)]+)\)/);
            const startX = currentXY ? currentXY[1] : '0px'; const startY = currentXY ? currentXY[2] : '0px';
            const cellCenterX = targetCell.offsetWidth / 2 - piece.offsetWidth / 2;
            const cellCenterY = targetCell.offsetHeight / 2 - piece.offsetHeight / 2;
            const endXval = cellCenterX + player.pieceOffsetX; const endYval = cellCenterY + player.pieceOffsetY;
            const endX = `${endXval}px`; const endY = `${endYval}px`;
            const midX = `calc((${startX} + ${endX}) / 2)`; const midY = `calc((${startY} + ${endY}) / 2 - 20px)`;
            piece.style.setProperty('--start-x', startX); piece.style.setProperty('--start-y', startY);
            piece.style.setProperty('--mid-x', midX); piece.style.setProperty('--mid-y', midY);
            piece.style.setProperty('--end-x', endX); piece.style.setProperty('--end-y', endY);
            targetCell.appendChild(piece); piece.classList.add('hop');
            await new Promise(resolve => setTimeout(() => {
                piece.classList.remove('hop');
                piece.style.transform = `translate(${endX}, ${endY})`;
                piece.style.setProperty('--current-x', endX); piece.style.setProperty('--current-y', endY);
                resolve();
            }, 600));
        }


        async function handlePosition(player) {
            const position = player.position;
            const cellElement = document.querySelector(`.board-cell[data-position="${position}"]`);
            const cellType = cellElement.dataset.type;
            let actionIsPending = false;

            if (position === 0) {
                showActionInfoModal("起點", `**${player.name}** 降落在起點，獲得 $200！`);
                player.money += 200; showMoneyChange(player, 200);
                playSound('passGo');
                actionIsPending = true;
            } else if (cellType === "go_to_jail") {
                showActionInfoModal("進監獄", `**${player.name}**，你慘了！直接進監獄！`);
                await goToJail(player);
                actionIsPending = true;
            } else if (boardProperties[position]) {
                const propData = boardProperties[position];
                if (propData.type === "tax") {
                    showActionInfoModal(propData.name, `**${player.name}** 需支付 ${propData.name} $${propData.price}。`);
                    player.money -= propData.price; showMoneyChange(player, -propData.price);
                    addMessage(`**${player.name}** 支付了 $${propData.price} ${propData.name}`);
                    playSound('pay');
                    actionIsPending = true;
                } else if (gameState.properties[position]) {
                    const owner = gameState.properties[position];
                    if (owner !== player && !player.inJail) {
                        let rent = 0;
                        if (propData.type === "property") rent = propData.rent;
                        else if (propData.type === "railroad") rent = 25 * Math.pow(2, owner.properties.filter(p => boardProperties[p]?.type === "railroad").length - 1);
                        else if (propData.type === "utility") rent = lastDiceRollTotal * (owner.properties.filter(p => boardProperties[p]?.type === "utility").length === 1 ? 4 : 10);

                        if (rent > 0) {
                            showActionInfoModal("支付租金", `**${player.name}** 降落在 **${owner.name}** 的 ${propData.name}，需支付租金 $${rent}。`);
                            player.money -= rent; owner.money += rent;
                            showMoneyChange(player, -rent); showMoneyChange(owner, rent);
                            addMessage(`**${player.name}** 支付 $${rent} 租金給 **${owner.name}**`);
                            playSound('pay');
                            actionIsPending = true;
                        }
                    } else if (owner === player) {
                        showActionInfoModal("自家地產", `**${player.name}** 降落在自己的 ${propData.name}。`);
                        actionIsPending = true;
                    }
                } else if (["property", "railroad", "utility"].includes(propData.type)) {
                    showBuyPropertyModal(player, position); actionIsPending = true;
                }
            } else if (cellType === "chance") {
                 playSound('chance');
                 await drawChanceCard(player); actionIsPending = true;
            } else if (cellType === "special" && position === 20) {
                showActionInfoModal("自由停車", `**${player.name}** 在此自由停車，休息一下。`);
                actionIsPending = true;
            } else if (cellType === "jail_visit" && position === 10) {
                 showActionInfoModal("監獄參觀", `**${player.name}** 只是來監獄參觀。`);
                 actionIsPending = true;
            }

            checkBankruptcy(player);
            updatePlayerDisplay();
            return actionIsPending;
        }

        function showActionInfoModal(title, details) {
            document.getElementById("actionInfoTitle").innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg> ${title}`;
            document.getElementById("actionInfoDetails").innerText = details.replace(/\*\*/g, "");
            document.getElementById("actionInfoModal").style.display = "flex";
        }
        function closeActionInfoModal() {
            document.getElementById("actionInfoModal").style.display = "none";
        }

        function showBuyPropertyModal(player, position) {
            const property = boardProperties[position];
            document.getElementById("propertyDetails").innerText = `是否購買 ${property.name}？價格: $${property.price}`;
            document.getElementById("buyPropertyModal").style.display = "flex";
        }

        async function buyAndClosePropertyModal(player, position) {
            await buyProperty(player, position);
            closeBuyPropertyModal(); attemptToEndTurn();
        }

        async function buyProperty(player, position) {
            const property = boardProperties[position];
            if (player.money >= property.price) {
                player.money -= property.price; player.properties.push(position);
                gameState.properties[position] = player; showMoneyChange(player, -property.price);
                addMessage(`**${player.name}** 購買了 ${property.name}，花費 $${property.price}`);
                playSound('buy');
                const cell = document.querySelector(`.board-cell[data-position="${position}"]`);
                const indicator = document.createElement("div");
                indicator.className = "owned-property-indicator"; indicator.classList.add(player.color);
                cell.appendChild(indicator);
            } else {
                addMessage(`**${player.name}** 資金不足，無法購買 ${property.name}`);
                playSound('error');
            }
            updatePlayerDisplay();
        }

        function closeBuyPropertyModal() { document.getElementById("buyPropertyModal").style.display = "none"; }

        async function drawChanceCard(player) {
            const card = gameState.chanceCards[Math.floor(Math.random() * gameState.chanceCards.length)];
            document.getElementById("chanceCardDetails").innerText = card.text;
            document.getElementById("chanceModal").style.display = "flex";
            addMessage(`**${player.name}** 抽到機會卡：${card.text}`);
            await card.action(player);
            checkBankruptcy(player); updatePlayerDisplay();
        }

        function closeChanceModal() { document.getElementById("chanceModal").style.display = "none"; }

        async function goToJail(player) {
            playSound('jail');
            addMessage(`**${player.name}** 被送往監獄！`);
            player.inJail = true; player.jailTurns = 0; player.position = 10;
            await movePlayerPieceAnimated(player);
            gameState.diceRolledThisTurn = true;
            updatePlayerDisplay();
        }

        async function payJailFine() {
            const player = gameState.players[gameState.currentPlayerIndex];
            gameState.diceRolledThisTurn = true;
            document.getElementById("payJailFineBtn").disabled = true;
            document.getElementById("rollDiceBtn").disabled = true;

            if (player.inJail && player.money >= 50) {
                player.money -= 50; player.inJail = false; player.jailTurns = 0;
                showMoneyChange(player, -50); addMessage(`**${player.name}** 支付 $50 保釋金，離開監獄`);
                playSound('buy');
            } else if (player.inJail && player.money < 50) {
                addMessage(`**${player.name}** 資金不足，無法支付保釋金`);
                playSound('error');
            }
            updatePlayerDisplay(); attemptToEndTurn();
        }

        function isModalOpen() {
            return document.getElementById("buyPropertyModal").style.display === "flex" ||
                   document.getElementById("chanceModal").style.display === "flex" ||
                   document.getElementById("rulesModal").style.display === "flex" ||
                   document.getElementById("actionInfoModal").style.display === "flex";
        }

        function attemptToEndTurn() {
            if (isModalOpen()) return;
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            if (currentPlayer.inJail && !gameState.diceRolledThisTurn) return;

            setTimeout(() => { if (gameState.gameStarted) endTurn(); }, AUTO_END_TURN_DELAY);
        }

        async function endTurn() {
            if (!gameState.gameStarted) return;
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            if (currentPlayer.inJail && gameState.diceRolledThisTurn) {
                if (currentPlayer.inJail && currentPlayer.jailTurns >= 3) {
                    addMessage(`**${currentPlayer.name}** 服刑滿三回合，必須支付 $50 離開監獄`);
                    if (currentPlayer.money >= 50) {
                        currentPlayer.money -= 50; showMoneyChange(currentPlayer, -50);
                        currentPlayer.inJail = false; addMessage(`**${currentPlayer.name}** 已支付保釋金。`);
                        playSound('buy');
                    } else {
                        addMessage(`**${currentPlayer.name}** 資金不足支付保釋金！`);
                        playSound('error');
                    }
                    currentPlayer.jailTurns = 0;
                }
            }
            checkBankruptcy(currentPlayer); if (!gameState.gameStarted) return;

            if (gameState.players.length > 0) {
                gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
                gameState.diceRolledThisTurn = false; lastDiceRollTotal = 0;

                document.getElementById("diceDisplay").innerHTML = diceInitialHTML;
                document.getElementById("rollDiceBtn").disabled = false;
                document.getElementById("payJailFineBtn").disabled = false;

                if (gameState.players[gameState.currentPlayerIndex]) {
                    addMessage(`輪到 **${gameState.players[gameState.currentPlayerIndex].name}** 的回合`);
                }
            }
            updatePlayerDisplay();
        }

        function showMoneyChange(player, amount) {
            const changeDiv = document.createElement("div");
            changeDiv.className = `money-change ${amount >= 0 ? "money-gain" : "money-loss"}`;
            changeDiv.innerText = `${amount >= 0 ? "+" : ""}$${Math.abs(amount)}`;
            const piece = document.querySelector(`.player-piece.${player.color}`);
            if (piece) {
                const rect = piece.getBoundingClientRect();
                changeDiv.style.left = `${rect.left + window.scrollX + rect.width / 2 - changeDiv.offsetWidth / 2}px`;
                changeDiv.style.top = `${rect.top + window.scrollY - 30}px`;
            } else {
                changeDiv.style.left = `50%`;
                changeDiv.style.top = `40%`;
                changeDiv.style.transform = `translateX(-50%)`;
            }
            document.body.appendChild(changeDiv);
            setTimeout(() => changeDiv.remove(), 1900);
        }
        function addMessage(message) {
            const messagesDiv = document.getElementById("gameMessages");
            const msgDiv = document.createElement("div");
            msgDiv.className = "message-new text-[var(--text-secondary)] p-1";
            msgDiv.innerText = message.replace(/\*\*/g, "");
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            gameState.gameLog.push(message);
        }
        function getPositionName(position) {
            if (boardProperties[position]) return boardProperties[position].name;
            const cell = document.querySelector(`.board-cell[data-position="${position}"]`);
            if (cell) {
                const textContent = cell.querySelector('.board-cell-content .text-xs:not(.font-bold)');
                if (textContent) return textContent.innerText.split('\n')[0];
            }
            switch (position) {
                case 0: return "起點"; case 10: return "監獄參觀";
                case 20: return "自由停車"; case 30: return "進監獄";
                default: return `位置 ${position}`;
            }
        }
        function checkBankruptcy(player) {
            if (!player) return;
            if (player.money < 0) {
                addMessage(`**${player.name}** 破產！`);
                playSound('error');
                player.properties.forEach(propPos => {
                    delete gameState.properties[propPos];
                    const cell = document.querySelector(`.board-cell[data-position="${propPos}"]`);
                    if (cell) { const indicator = cell.querySelector('.owned-property-indicator'); if (indicator) indicator.remove(); }
                });
                player.properties = [];
                const playerPiece = document.querySelector(`.player-piece.${player.color}`);
                if (playerPiece) playerPiece.remove();
                const playerIndexInArray = gameState.players.findIndex(p => p.id === player.id);
                if (playerIndexInArray === -1) return;

                let wasCurrentPlayer = (playerIndexInArray === gameState.currentPlayerIndex);

                gameState.players.splice(playerIndexInArray, 1);

                if (gameState.players.length === 1) {
                    addMessage(`**${gameState.players[0].name}** 獲勝！遊戲結束！`);
                    playSound('win'); triggerConfetti();
                    gameState.gameStarted = false; updatePlayerDisplay(); return;
                } else if (gameState.players.length === 0) {
                    addMessage("所有玩家都破產了！平局！");
                    playSound('error');
                    gameState.gameStarted = false;
                    updatePlayerDisplay(); return;
                }

                if (wasCurrentPlayer) {
                     gameState.currentPlayerIndex = playerIndexInArray % gameState.players.length;
                } else if (playerIndexInArray < gameState.currentPlayerIndex) {
                    gameState.currentPlayerIndex--;
                }
                if (gameState.currentPlayerIndex >= gameState.players.length) {
                    gameState.currentPlayerIndex = 0;
                }
                if (gameState.gameStarted && gameState.players.length > 0 && gameState.players[gameState.currentPlayerIndex]) {
                     addMessage(`輪到 **${gameState.players[gameState.currentPlayerIndex].name}** 的回合`);
                }
            }
        }
        function triggerConfetti() {
            const confettiContainer = document.getElementById('confetti-container');
            confettiContainer.innerHTML = '';
            const colors = ['#fde047', '#fca5a5', '#86efac', '#93c5fd', '#c4b5fd', '#f9a8d4', '#facc15', '#4ade80', '#60a5fa'];
            for (let i = 0; i < 150; i++) {
                const confettiPiece = document.createElement('div');
                confettiPiece.className = 'confetti-piece';
                confettiPiece.style.left = Math.random() * 100 + 'vw';
                confettiPiece.style.width = Math.random() * 10 + 8 + 'px';
                confettiPiece.style.height = Math.random() * 20 + 10 + 'px';
                confettiPiece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confettiPiece.style.opacity = Math.random() * 0.4 + 0.6;
                confettiPiece.style.transform = `translateY(-10vh) rotate(${Math.random() * 720 - 360}deg)`;
                confettiPiece.style.animationDuration = Math.random() * 3 + 4 + 's';
                confettiPiece.style.animationDelay = Math.random() * 1 + 's';
                confettiContainer.appendChild(confettiPiece);
            }
            setTimeout(() => confettiContainer.innerHTML = '', 8000);
        }
        function toggleTheme() { document.documentElement.classList.toggle("dark"); }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const soundSwitcher = document.getElementById("soundSwitcher");
            soundSwitcher.classList.toggle("sound-on", soundEnabled);
            soundSwitcher.classList.toggle("sound-off", !soundEnabled);
            addMessage(`音效已 ${soundEnabled ? "開啟" : "關閉"}`);
            if (soundEnabled && audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function downloadGameLog() {
            if (!gameState.gameLog || gameState.gameLog.length === 0) {
                addMessage("目前沒有遊戲歷程可下載。");
                return;
            }
            const logContent = gameState.gameLog.join("\n");

            const blob = new Blob([logContent], { type: "text/markdown;charset=utf-8" });
            const now = new Date();
            const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
            const filename = `大富翁遊戲歷程_${timestamp}.txt`;

            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            addMessage("遊戲歷程已下載。");
        }

        function showRulesModal() { document.getElementById("rulesModal").style.display = "flex"; }
        function closeRulesModal() { document.getElementById("rulesModal").style.display = "none"; }

        document.addEventListener("DOMContentLoaded", () => {
            initializeEventListeners();
            updatePlayerDisplay();
            addMessage("歡迎體驗大富翁神金利餘遊戲系統！請選擇玩家數量並開始遊戲。");
        });
    </script>
</body>
</html>